{% extends 'detection/base.html' %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="jumbotron shadow p-4 rounded">
            <h1 class="display-4"><i class="fas fa-shield-alt" style="color: #a753e4;"></i> ARGUS IA</h1>
            <p class="lead">Sistema Inteligente de Detec√ß√£o de Padr√µes Suspeitos em Redes Sociais</p>
            <hr class="my-4">
            <a href="{% url 'detection:analyze_page' %}" class="btn btn-lg"
                style="background-color: #a753e4; color: white;">
                <i class="fas fa-brain"></i> Realizar An√°lise com ML
            </a>
            <a href="{% url 'detection:generate_dataset_page' %}" class="btn btn-lg"
                style="background-color: #28a745; color: white;">
                <i class="fas fa-plus-circle"></i> Gerar Novo Dataset
            </a>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- Estat√≠sticas Gerais -->
    <div class="col-md-3">
        <div class="card stat-card shadow" style="background-color: #a753e4; color: white;">
            <div class="card-body text-center">
                <i class="fas fa-database fa-2x mb-2"></i>
                <h5 class="card-title">Datasets Gerados</h5>
                <h2 class="card-text">{{ total_datasets }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card shadow" style="background-color: #7a2bb3 ; color: white;">
            <div class="card-body text-center">
                <i class="fas fa-chart-bar fa-2x mb-2"></i>
                <h5 class="card-title">An√°lises</h5>
                <h2 class="card-text">{{ total_analyses }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card shadow" style="background-color: #c88df7 ; color: white;">
            <div class="card-body text-center">
                <i class="fas fa-robot fa-2x mb-2"></i>
                <h5 class="card-title">Posts Analisados</h5>
                <h2 class="card-text">{{ total_posts_analyzed }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card shadow" style="background-color: #6b4e91 ; color: white;">
            <div class="card-body text-center">
                <i class="fas fa-bolt fa-2x mb-2"></i>
                <h5 class="card-title">Coment√°rios Analisados</h5>
                <h2 class="card-text">{{ total_comments_analyzed }}</h2>
            </div>
        </div>
    </div>
</div>


<div class="col-md-12">
    <!-- Informa√ß√µes de Formato -->
    <div class="card">
        <div class="card-header bg-info text-white">
            <h6 class="card-title mb-0"><i class="fas fa-info-circle"></i> Formato do Dataset</h6>
        </div>
        <div class="card-body">
            <h6>posts.csv:</h6>
            <code class="small">
                    post_id,user_id,username,caption,post_date,likes_count<br>
                    1,101,user_1,"Post exemplo",2024-01-01,45
                </code>

            <h6 class="mt-3">comments.csv:</h6>
            <code class="small">
                    comment_id,post_id,user_id,username,comment_text,comment_date<br>
                    1,1,201,user_2,"Coment√°rio",2024-01-01
                </code>

            <div class="mt-3">
                <a href="{% url 'detection:generate_dataset_page' %}" class="btn btn-outline-primary btn-sm w-100">
                    <i class="fas fa-download"></i> Baixar Template
                </a>
            </div>
        </div>
    </div>

    <!-- An√°lises Recentes -->
    <div class="card mt-3">
        <div class="card-header">
            <h6 class="card-title mb-0"><i class="fas fa-history"></i> An√°lises Recentes</h6>
        </div>
        <div class="card-body">
            {% if recent_analyses %}
            {% for analysis in recent_analyses|slice:":3" %}
            <a href="{% url 'detection:analysis_results' analysis.id %}"
                class="d-flex justify-content-between align-items-center mb-2 text-decoration-none">
                <small>{{ analysis.dataset.name|truncatewords:3 }}</small>
                <span class="badge {% if analysis.suspicious_count > 0 %}bg-danger{% else %}bg-success{% endif %}">
                    {{ analysis.suspicious_count }}
                </span>
            </a>
            {% endfor %}

            <!-- Bot√£o - Ver Todas -->
            <a href="{% url 'detection:all_analyses' %}"
               class="btn btn-outline-secondary btn-sm w-100 mt-2">
                Ver Todas
            </a>

            {% else %}
            <p class="text-muted small mb-0">Nenhuma an√°lise recente</p>
            {% endif %}

        </div>
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}

<script>
    // Fun√ß√£o para mostrar alertas - COMPLETA
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);

        // Auto-remove ap√≥s 5 segundos
        setTimeout(() => {
            if (alertDiv.parentElement) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Upload de Dataset
    document.getElementById('uploadDatasetForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const uploadBtn = document.getElementById('uploadBtn');
        const originalText = uploadBtn.innerHTML;

        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';

        const formData = new FormData();
        formData.append('posts_file', document.getElementById('postsFile').files[0]);
        formData.append('comments_file', document.getElementById('commentsFile').files[0]);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        try {
            const response = await fetch('{% url "detection:upload_dataset" %}', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                document.getElementById('datasetDetails').innerHTML = `
                <div class="row">
                    <div class="col-6">
                        <strong>${result.dataset.name}</strong><br>
                        <small>Posts: ${result.dataset.posts_count}</small>
                    </div>
                    <div class="col-6">
                        <small>Coment√°rios: ${result.dataset.comments_count}</small><br>
                        <small class="text-success">‚úì Dataset carregado!</small>
                    </div>
                </div>
            `;

                document.getElementById('datasetInfo').classList.remove('d-none');
                document.getElementById('noDatasetInfo').classList.add('d-none');
                document.getElementById('uploadSection').classList.add('d-none');

                showAlert('‚úÖ Dataset carregado com sucesso!', 'success');
            } else {
                showAlert('‚ùå Erro ao carregar dataset: ' + result.error, 'danger');
            }
        } catch (error) {
            showAlert('‚ùå Erro de conex√£o: ' + error.message, 'danger');
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = originalText;
        }
    });

    // Executar An√°lise - FUNCIONAL
    document.getElementById('analyzeBtn').addEventListener('click', async function () {
        const analyzeBtn = document.getElementById('analyzeBtn');
        const progressDiv = document.getElementById('analysisProgress');
        const originalText = analyzeBtn.innerHTML;

        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analisando...';
        progressDiv.classList.remove('d-none');

        try {
            const response = await fetch('{% url "detection:analyze_dataset" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({})
            });

            const result = await response.json();

            if (result.success) {
                showAlert(
                    `‚úÖ An√°lise conclu√≠da com sucesso!<br>
                üìä Coment√°rios analisados: ${result.analysis.total_comments.toLocaleString()}<br>
                üö® Suspeitos detectados: ${result.analysis.suspicious_count}<br>
                üìà Taxa de detec√ß√£o: ${result.analysis.suspicious_percentage.toFixed(2)}%<br>
                üß† Acur√°cia: ${(result.analysis.accuracy * 100).toFixed(2)}%`,
                    'success'
                );

                // Redirecionar para resultados
                setTimeout(() => {
                    window.location.href = `/results/${result.analysis.id}/`;
                }, 3000);
            } else {
                showAlert('‚ùå Erro na an√°lise: ' + result.error, 'danger');
            }
        } catch (error) {
            showAlert('‚ùå Erro de conex√£o: ' + error.message, 'danger');
        } finally {
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = originalText;
            progressDiv.classList.add('d-none');
        }
    });

    // Fun√ß√µes auxiliares
    function scrollToAnalyses() {
        const analysesSection = document.getElementById('analysesSection');
        if (analysesSection) {
            analysesSection.scrollIntoView({ behavior: 'smooth' });
        }
    }

    function showAllAnalyses() {
        scrollToAnalyses();
    }
</script>
{% endblock %}